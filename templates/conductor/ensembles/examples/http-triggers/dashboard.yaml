name: dashboard
description: User analytics dashboard with data visualization and HTMX interactions

trigger:
  - type: http
    path: /dashboard
    methods: [GET]
    auth:
      type: bearer
      secret: $env.AUTH_TOKEN
    # Private cache - user-specific content, only browser can cache
    httpCache:
      private: true   # Browser only, not CDN
      noStore: true   # Sensitive user data - don't store
      vary: [Authorization]  # Different cache per user
    responses:
      html:
        enabled: true
      json:
        enabled: true

flow:
  - agent: fetch-user
    input:
      userId: ${input.userId}

agents:
  # Fetch analytics metrics (D1) - requires D1 setup
  - name: fetch-metrics
    operation: data
    config:
      database: d1
      query: |
        SELECT
          metric_name as label,
          current_value as value,
          change_percent as change,
          trend
        FROM analytics_metrics
        WHERE user_id = ?
        ORDER BY sort_order
      params:
        - $fetch-user.id

  # Render dashboard
  - name: render-dashboard
    operation: html
    config:
      templateEngine: liquid
      template: |
        <div class="dashboard">
          <header class="dashboard-header">
            <div>
              <h1>{{title}}</h1>
              <p>Welcome back, {{user.name}}!</p>
            </div>
            <div class="header-actions">
              <button class="btn-secondary" hx-get="/api/refresh" hx-target="#stats-grid">
                Refresh
              </button>
              <a href="/settings" class="btn-secondary">Settings</a>
            </div>
          </header>

          <div class="stats-grid" id="stats-grid">
            {% for metric in metrics %}
            <div class="stat-card">
              <h3>{{metric.label}}</h3>
              <p class="stat-value">{{metric.value}}</p>
              <span class="stat-change {{metric.trend}}">
                {{metric.change}}
              </span>
            </div>
            {% endfor %}
          </div>

          <div class="charts-section">
            <div class="chart-container">
              <h2>Activity Over Time</h2>
              <div
                hx-get="/api/chart-data?type=activity"
                hx-trigger="load"
                hx-indicator="#loading-activity"
              >
                <div id="loading-activity" class="loading">Loading chart...</div>
              </div>
            </div>

            <div class="chart-container">
              <h2>Performance Metrics</h2>
              <div
                hx-get="/api/chart-data?type=performance"
                hx-trigger="load"
                hx-indicator="#loading-performance"
              >
                <div id="loading-performance" class="loading">Loading chart...</div>
              </div>
            </div>
          </div>

          <div class="recent-activity">
            <h2>Recent Activity</h2>
            <div
              hx-get="/api/recent-activity"
              hx-trigger="load, every 30s"
              hx-swap="innerHTML"
            >
              <div class="loading">Loading activity...</div>
            </div>
          </div>
        </div>
      styles: |
        body {
          font-family: system-ui, -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
          margin: 0;
          padding: 0;
          background: #f8f9fa;
        }
        .dashboard {
          max-width: 1400px;
          margin: 0 auto;
          padding: 2rem;
        }
        .dashboard-header {
          display: flex;
          justify-content: space-between;
          align-items: center;
          margin-bottom: 2rem;
          padding-bottom: 1.5rem;
          border-bottom: 2px solid #e9ecef;
        }
        .dashboard-header h1 {
          font-size: 2rem;
          margin: 0 0 0.5rem 0;
          color: #212529;
        }
        .dashboard-header p {
          margin: 0;
          color: #6c757d;
        }
        .header-actions {
          display: flex;
          gap: 1rem;
        }
        .btn-secondary {
          padding: 0.75rem 1.5rem;
          background: white;
          color: #667eea;
          border: 2px solid #667eea;
          border-radius: 8px;
          text-decoration: none;
          font-weight: 600;
          cursor: pointer;
          transition: all 0.2s;
        }
        .btn-secondary:hover {
          background: #667eea;
          color: white;
        }
        .stats-grid {
          display: grid;
          grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
          gap: 1.5rem;
          margin-bottom: 3rem;
        }
        .stat-card {
          background: white;
          padding: 2rem;
          border-radius: 12px;
          box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        .stat-card h3 {
          font-size: 0.875rem;
          text-transform: uppercase;
          letter-spacing: 0.05em;
          color: #6c757d;
          margin: 0 0 1rem 0;
        }
        .stat-value {
          font-size: 2rem;
          font-weight: 700;
          color: #212529;
          margin: 0 0 0.5rem 0;
        }
        .stat-change {
          font-size: 0.875rem;
          font-weight: 600;
        }
        .stat-change.up {
          color: #28a745;
        }
        .stat-change.up::before {
          content: '↑ ';
        }
        .stat-change.down {
          color: #dc3545;
        }
        .stat-change.down::before {
          content: '↓ ';
        }
        .stat-change.neutral {
          color: #6c757d;
        }
        .charts-section {
          display: grid;
          grid-template-columns: repeat(auto-fit, minmax(500px, 1fr));
          gap: 1.5rem;
          margin-bottom: 3rem;
        }
        .chart-container {
          background: white;
          padding: 2rem;
          border-radius: 12px;
          box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        .chart-container h2 {
          font-size: 1.25rem;
          margin: 0 0 1.5rem 0;
          color: #212529;
        }
        .recent-activity {
          background: white;
          padding: 2rem;
          border-radius: 12px;
          box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        .recent-activity h2 {
          font-size: 1.25rem;
          margin: 0 0 1.5rem 0;
          color: #212529;
        }
        .loading {
          text-align: center;
          padding: 2rem;
          color: #6c757d;
        }
      seo:
        title: "Dashboard"
        description: "User analytics and metrics dashboard"
        robots: noindex, nofollow
      meta:
        - name: viewport
          content: width=device-width, initial-scale=1
      scripts:
        - src: https://unpkg.com/htmx.org@1.9.10
    input:
      title: Analytics Dashboard
      user: $fetch-user
      metrics: $fetch-metrics.rows

input:
  userId: null

output:
  html: ${render-dashboard.output}
