name: data-export-email
description: |
  Export data to CSV/Excel and email it as an attachment.
  Demonstrates:
  - Data export with multiple format options (CSV, JSON, Excel, NDJSON)
  - Email with file attachments
  - Base64 encoding for email compatibility
  - Streaming support for large datasets

flow:
  # Step 1: Export data from storage
  - agent: export-data
    operation: code
    config:
      script: scripts/examples/data/export-data
    input:
      prefix: ${input.dataPrefix}
      format: ${input.format}  # csv, json, xlsx, or ndjson
      exportOptions:
        headers: true
        fields: ${input.fields}  # Optional: specify field order
        pretty: true  # For JSON format
        sheetName: "Exported Data"  # For Excel format
      streaming: false  # Set to true for large datasets
    output: exportResult

  # Step 2: Prepare attachment from export
  - agent: prepare-attachment
    operation: code
    config:
      script: scripts/examples/data/prepare-attachment
    input:
      exportResult: ${export-data.exportResult}
      format: ${input.format}
      filename: ${input.filename}
    output: attachment

  # Step 3: Send email with attachment
  - agent: send-email
    operation: email
    config:
      provider:
        operation: resend
        apiKey: ${env.RESEND_API_KEY}
        from: "reports@example.com"
    input:
      to: ${input.recipient}
      subject: ${input.subject}
      html: |
        <h2>Data Export Report</h2>
        <p>Your requested data export is attached.</p>
        <ul>
          <li><strong>Format:</strong> {{format}}</li>
          <li><strong>Records:</strong> {{count}}</li>
          <li><strong>File:</strong> {{filename}}</li>
        </ul>
        <p>Generated at {{timestamp}}</p>
      data:
        format: ${input.format}
        count: ${export-data.count}
        filename: ${prepare-attachment.filename}
        timestamp: ${now}
      attachments:
        - filename: ${prepare-attachment.filename}
          content: ${prepare-attachment.content}
          contentType: ${prepare-attachment.contentType}
          encoding: ${prepare-attachment.encoding}

# Input schema
schema:
  input:
    dataPrefix: string  # KV prefix to export
    format: string  # csv, json, xlsx, or ndjson
    recipient: string
    subject: string
    filename: string?
    fields: array?  # Optional field order

# Example usage:
#   POST /execute/data-export-email
#   {
#     "dataPrefix": "users:",
#     "format": "csv",
#     "recipient": "admin@example.com",
#     "subject": "User Data Export",
#     "filename": "users-export.csv",
#     "fields": ["id", "email", "name", "created_at"]
#   }
