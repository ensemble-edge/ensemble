name = "my-conductor-project"
main = "dist/index.mjs"
compatibility_date = "2025-10-29"
compatibility_flags = ["nodejs_compat"]

# Build configuration for Vite
[build]
command = "pnpm run build"
# ‚ö†Ô∏è YAML Hot-Reload Limitation:
# Wrangler dev watches src/ for TypeScript changes, but changes to
# ensembles/*.yaml or agents/*/agent.yaml require a server restart.
#
# Workaround: Use `pnpm run dev:watch` (if available) or restart wrangler dev
# after editing YAML files. See package.json for dev scripts.

# Module rules for file imports (kept for backward compatibility)
[[rules]]
type = "Text"
globs = ["**/*.yaml", "**/*.yml"]
fallthrough = true

# ==================== Local Development Secrets ====================
# For local development, copy .dev.vars.example to .dev.vars and add your secrets:
#   cp .dev.vars.example .dev.vars
#
# For production, use wrangler secrets (NOT environment variables):
#   wrangler secret put ANTHROPIC_API_KEY
#   wrangler secret put OPENAI_API_KEY
#
# Learn more: https://developers.cloudflare.com/workers/configuration/secrets/

# ==================== Durable Objects ====================
# Required for stateful workflows, async execution tracking, and HITL
# Uncomment when you need stateful workflows:
# [[durable_objects.bindings]]
# name = "EXECUTION_STATE"
# class_name = "ExecutionState"
# script_name = "my-conductor-project"
#
# [[durable_objects.bindings]]
# name = "HITL_STATE"
# class_name = "HITLState"
# script_name = "my-conductor-project"
#
# [[migrations]]
# tag = "v1"
# new_classes = ["ExecutionState", "HITLState"]

# ==================== Cloudflare Bindings ====================
# Comment out bindings you don't need. All are optional except for Durable Objects above.

# R2 for static assets (images, fonts, global CSS)
# Uncomment when you set up an R2 bucket:
# [[r2_buckets]]
# binding = "ASSETS"
# bucket_name = "conductor-assets"
# preview_bucket_name = "conductor-assets-preview"

# KV for caching and fast lookups
# Uncomment when you create KV namespaces:
# [[kv_namespaces]]
# binding = "CACHE"
# id = "your-kv-namespace-id"
# preview_id = "your-preview-kv-id"

# D1 database for long-term memory
# Uncomment when you create a D1 database:
# [[d1_databases]]
# binding = "DB"
# database_name = "conductor-db"
# database_id = "your-d1-database-id"

# Vectorize for semantic memory (RAG)
# Uncomment when you create a Vectorize index:
# [[vectorize]]
# binding = "VECTORIZE"
# index_name = "conductor-embeddings"

# Email sending via Cloudflare Email Routing
# Uncomment when using Cloudflare email provider:
# [[send_email]]
# name = "EMAIL"
# destination_address_list = "allowed-recipients"

# SMS configuration (via secrets - use wrangler secret put)
# Required secrets for Twilio:
#   wrangler secret put TWILIO_ACCOUNT_SID
#   wrangler secret put TWILIO_AUTH_TOKEN
#   wrangler secret put TWILIO_PHONE_NUMBER

# Hyperdrive bindings for external databases
# Uncomment and configure when connecting to external databases:
# [[hyperdrive]]
# binding = "PRODUCTION_DB"
# id = "your-hyperdrive-id-production"
#
# [[hyperdrive]]
# binding = "ANALYTICS_DB"
# id = "your-hyperdrive-id-analytics"

# ==================== Analytics Engine (for Observability) ====================
# Provides SQL-queryable high-cardinality metrics for production monitoring.
# Metrics include ensemble duration, agent success/failure, cache performance, etc.
#
# To enable:
# 1. Go to Cloudflare Dashboard ‚Üí Workers & Pages ‚Üí Analytics Engine
# 2. Create a new dataset (e.g., "conductor-metrics")
# 3. Uncomment the binding below and add your dataset name
#
# [[analytics_engine_datasets]]
# binding = "ANALYTICS"
# dataset = "conductor-metrics"
#
# üìä Example queries:
#   -- Average ensemble execution time
#   SELECT blob1 as ensemble, AVG(double1) as avg_duration_ms
#   FROM conductor_metrics WHERE index1 = 'ensemble.execution'
#   GROUP BY blob1 ORDER BY avg_duration_ms DESC
#
#   -- Agent error rate
#   SELECT blob1 as agent, SUM(double2) as errors, COUNT(*) as total
#   FROM conductor_metrics WHERE index1 = 'agent.execution'
#   GROUP BY blob1

# ==================== Workers AI (for Think Agents) ====================
# Required for AI-powered agents using operation: think
# The suggest-pages and ai-greeting examples require this binding
[ai]
binding = "AI"

# üìã Workers AI Setup (for local development):
# 1. Create an API token with Workers AI permissions:
#    - Go to: dash.cloudflare.com ‚Üí My Profile ‚Üí API Tokens
#    - Create token with: Account ‚Üí Workers AI ‚Üí Edit
# 2. Add token to .dev.vars: CLOUDFLARE_API_TOKEN=your-token
# 3. Run: CLOUDFLARE_API_TOKEN="..." wrangler dev
#
# Example think agent (agents/my-agent/agent.yaml):
#   name: my-agent
#   operation: think
#   config:
#     provider: workers-ai
#     model: "@cf/meta/llama-3.1-8b-instruct"
#   prompt: "Your prompt here with {{input.field}} variables"

# ==================== Environment Variables ====================
[vars]
ENVIRONMENT = "development"
# Optional: API key authentication (comma-separated)
# API_KEYS = "key1,key2,key3"
# ALLOW_ANONYMOUS = "false"
# DISABLE_LOGGING = "false"

# ==================== Scheduled Triggers (Cron) ====================
# Add cron expressions from your ensemble schedules here
# To get all cron expressions: GET /api/v1/schedules/crons/list
[triggers]
crons = [
  # Example schedules (configure based on your ensembles)
  # "0 9 * * *",      # Daily at 9 AM UTC
  # "0 */4 * * *",    # Every 4 hours
  # "*/15 * * * *"    # Every 15 minutes
]
